require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '15.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorDevice', :path => '../../node_modules/@capacitor/device'
  pod 'CapacitorLocalNotifications', :path => '../../node_modules/@capacitor/local-notifications'
  pod 'CapacitorPreferences', :path => '../../node_modules/@capacitor/preferences'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CodetrixStudioCapacitorGoogleAuth', :path => '../../node_modules/@codetrix-studio/capacitor-google-auth'
end

target 'App' do
  capacitor_pods
  # Firebase for push notifications
  pod 'Firebase/Messaging'
  pod 'Firebase/Core'
  
  # Override Google SDK versions to include Privacy Manifest support
  # GoogleSignIn 7.0+ includes PrivacyInfo.xcprivacy
  # Force override plugin's dependency constraint
  pod 'GoogleSignIn', '~> 7.0'
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  # Patch plugin's podspec to allow GoogleSignIn 7.0
  plugin_podspec_path = File.expand_path('../../node_modules/@codetrix-studio/capacitor-google-auth/CodetrixStudioCapacitorGoogleAuth.podspec', __dir__)
  if File.exist?(plugin_podspec_path)
    podspec_content = File.read(plugin_podspec_path)
    if podspec_content.include?("s.dependency 'GoogleSignIn', '~> 6.2.4'")
      podspec_content.gsub!("s.dependency 'GoogleSignIn', '~> 6.2.4'", "s.dependency 'GoogleSignIn', '~> 7.0'")
      File.write(plugin_podspec_path, podspec_content)
      puts "✅ Patched CodetrixStudioCapacitorGoogleAuth.podspec to use GoogleSignIn ~> 7.0"
    end
  end
  
  # Patch Plugin.swift to fix GoogleSignIn 7.0 API compatibility
  plugin_swift_path = File.expand_path('../../node_modules/@codetrix-studio/capacitor-google-auth/ios/Plugin/Plugin.swift', __dir__)
  if File.exist?(plugin_swift_path)
    swift_content = File.read(plugin_swift_path)
    original_content = swift_content.dup
    
    # Fix deprecated getConfigValue calls
    swift_content.gsub!(/getConfigValue\("scopes"\) as\? \[String\]/, '(getConfig().getArray("scopes") as? [String]) ?? []')
    swift_content.gsub!(/getConfigValue\("forceCodeForRefreshToken"\) as\? Bool/, 'getConfig().getBoolean("forceCodeForRefreshToken", false)')
    
    # Fix getArray calls to use proper Capacitor API
    swift_content.gsub!(/getConfig\(\)\.getArray\("scopes", String\.self\)/, 'getConfig().getArray("scopes") as? [String]')
    swift_content.gsub!(/call\.getArray\("scopes", String\.self\)/, 'call.getArray("scopes") as? [String]')
    
    # Fix duplicate operators
    swift_content.gsub!(/getConfig\(\)\.getArray\("scopes"\) as\? \[String\] \?\? \[\] \?\? \[\]/, '(getConfig().getArray("scopes") as? [String]) ?? []')
    swift_content.gsub!(/getConfig\(\)\.getBoolean\("forceCodeForRefreshToken", false\) \?\? false/, 'getConfig().getBoolean("forceCodeForRefreshToken", false)')
    
    # Fix DispatchQueue.main.async - use explicit DispatchWorkItem to avoid trailing closure issues
    # Replace DispatchQueue.main.async { } with DispatchWorkItem pattern
    swift_content.gsub!(/DispatchQueue\.main\.async \{([\s\S]*?)\}\s*$/) do |match|
      content = $1
      # Create DispatchWorkItem pattern
      "let workItem = DispatchWorkItem {\n#{content}\n        }\n        DispatchQueue.main.async(execute: workItem)"
    end
    
    # Fix GoogleSignIn 7.0 API: user.authentication is now async
    # Replace user.authentication.accessToken with async call
    if swift_content.include?('user.authentication.accessToken')
      # Update resolveSignInCallWith to use async authentication
      resolve_function = <<~SWIFT
    func resolveSignInCallWith(user: GIDGoogleUser, serverAuthCode: String?) {
        user.refreshTokensIfNeeded { refreshedUser, error in
            guard let user = refreshedUser, error == nil else {
                self.signInCall?.reject(error?.localizedDescription ?? "Failed to get authentication");
                return;
            }
            
            var userData: [String: Any] = [
                "authentication": [
                    "accessToken": user.accessToken.tokenString,
                    "idToken": user.idToken?.tokenString ?? NSNull(),
                    "refreshToken": user.refreshToken.tokenString
                ],
                "serverAuthCode": serverAuthCode ?? NSNull(),
                "email": user.profile?.email ?? NSNull(),
                "familyName": user.profile?.familyName ?? NSNull(),
                "givenName": user.profile?.givenName ?? NSNull(),
                "id": user.userID ?? NSNull(),
                "name": user.profile?.name ?? NSNull()
            ];
            if let imageUrl = user.profile?.imageURL(withDimension: 100)?.absoluteString {
                userData["imageUrl"] = imageUrl;
            }
            self.signInCall?.resolve(userData);
        }
    }
      SWIFT
      
      # Replace the old resolveSignInCallWith function
      old_function_pattern = /func resolveSignInCallWith\(user: GIDGoogleUser\) \{[\s\S]*?signInCall\?\.resolve\(userData\);\s*\}\s*\}/
      swift_content.gsub!(old_function_pattern, resolve_function.strip)
      
      # Fix signIn to use GIDSignInResult (returns GIDSignInResult)
      swift_content.gsub!(/self\.googleSignIn\.signIn\(with: self\.googleSignInConfiguration, presenting: presentingVc, hint: nil, additionalScopes: self\.additionalScopes\) \{ user, error in/, 'self.googleSignIn.signIn(with: self.googleSignInConfiguration, presenting: presentingVc, hint: nil, additionalScopes: self.additionalScopes) { result, error in')
      
      # Fix restorePreviousSignIn - it returns GIDGoogleUser directly, not GIDSignInResult
      # So we need to pass nil for serverAuthCode
      swift_content.gsub!(/self\.googleSignIn\.restorePreviousSignIn\(\) \{ result, error in[\s\S]*?self\.resolveSignInCallWith\(user: result\.user, serverAuthCode: result\.serverAuthCode\);/m) do |match|
        'self.googleSignIn.restorePreviousSignIn() { user, error in
                    if let error = error {
                        self.signInCall?.reject(error.localizedDescription);
                        return;
                    }
                    guard let user = user else {
                        self.signInCall?.reject("Restore sign in failed: no user");
                        return;
                    }
                    // restorePreviousSignIn returns GIDGoogleUser directly, not GIDSignInResult
                    // serverAuthCode is only available from signIn (GIDSignInResult)
                    self.resolveSignInCallWith(user: user, serverAuthCode: nil);'
      end
      
      # Update signIn completion to use result.user and result.serverAuthCode
      swift_content.gsub!(/guard let result = result else \{\s*self\.signInCall\?\.reject\("Sign in failed: no result"\);\s*return;\s*\}\s*self\.resolveSignInCallWith\(user: result\.user, serverAuthCode: result\.serverAuthCode\);/m, 'guard let result = result else {\n                        self.signInCall?.reject("Sign in failed: no result");\n                        return;\n                    }\n                    self.resolveSignInCallWith(user: result.user, serverAuthCode: result.serverAuthCode);')
      
      # Fix signIn completion handler
      if swift_content.include?('self.resolveSignInCallWith(user: user!)')
        swift_content.gsub!(/self\.resolveSignInCallWith\(user: user!\);/) do |match|
          # Check if it's in a signIn or restorePreviousSignIn context
          if swift_content.match(/signIn.*\{ result, error/)
            'guard let result = result else {\n                        self.signInCall?.reject("Sign in failed: no result");\n                        return;\n                    }\n                    self.resolveSignInCallWith(user: result.user, serverAuthCode: result.serverAuthCode);'
          else
            match
          end
        end
      end
      
      # Fix indentation for resolveSignInCallWith
      swift_content.gsub!(/^    func resolveSignInCallWith\(user: GIDGoogleUser\) \{/, '    func resolveSignInCallWith(user: GIDGoogleUser) {')
      swift_content.gsub!(/^    user\.refreshTokensIfNeeded/, '        user.refreshTokensIfNeeded')
    end
    
    # Fix refresh function to use new API
    if swift_content.include?('currentUser!.authentication.do')
      refresh_function = <<~SWIFT
    @objc
    func refresh(_ call: CAPPluginCall) {
        DispatchQueue.main.async(execute: {
            guard let user = self.googleSignIn.currentUser else {
                call.reject("User not logged in.");
                return
            }
            user.refreshTokensIfNeeded { refreshedUser, error in
                guard let user = refreshedUser, error == nil else {
                    call.reject(error?.localizedDescription ?? "Something went wrong.");
                    return;
                }
                let authenticationData: [String: Any] = [
                    "accessToken": user.accessToken.tokenString,
                    "idToken": user.idToken?.tokenString ?? NSNull(),
                    "refreshToken": user.refreshToken.tokenString
                ]
                call.resolve(authenticationData);
            }
        })
    }
      SWIFT
      
      old_refresh_pattern = /@objc\s+func refresh\(_ call: CAPPluginCall\) \{[\s\S]*?call\.resolve\(authenticationData\);\s*\}\s*\}\s*\}/
      swift_content.gsub!(old_refresh_pattern, refresh_function.strip)
      
      # Fix indentation for refresh function
      swift_content.gsub!(/^@objc\nfunc refresh\(_ call: CAPPluginCall\) \{/, '@objc\n    func refresh(_ call: CAPPluginCall) {')
      
      # Remove extra closing braces at end of file
      swift_content.gsub!(/^}\s*$/, '') if swift_content.scan(/^}\s*$/).length > 1
    end
    
    if swift_content != original_content
      File.write(plugin_swift_path, swift_content)
      puts "✅ Patched Plugin.swift for GoogleSignIn 7.0 API compatibility"
    end
  end
  
  # Set minimum deployment target for all targets
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      if config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'].to_f < 15.0
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      end
    end
  end
end
