require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '15.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorDevice', :path => '../../node_modules/@capacitor/device'
  pod 'CapacitorLocalNotifications', :path => '../../node_modules/@capacitor/local-notifications'
  pod 'CapacitorPreferences', :path => '../../node_modules/@capacitor/preferences'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CodetrixStudioCapacitorGoogleAuth', :path => '../../node_modules/@codetrix-studio/capacitor-google-auth'
end

target 'App' do
  capacitor_pods
  # Firebase for push notifications
  pod 'Firebase/Messaging'
  pod 'Firebase/Core'
  
  # Override Google SDK versions to include Privacy Manifest support
  # GoogleSignIn 7.0+ includes PrivacyInfo.xcprivacy
  # Force override plugin's dependency constraint
  pod 'GoogleSignIn', '~> 7.0'
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  # Patch plugin's podspec to allow GoogleSignIn 7.0
  plugin_podspec_path = File.expand_path('../../node_modules/@codetrix-studio/capacitor-google-auth/CodetrixStudioCapacitorGoogleAuth.podspec', __dir__)
  if File.exist?(plugin_podspec_path)
    podspec_content = File.read(plugin_podspec_path)
    if podspec_content.include?("s.dependency 'GoogleSignIn', '~> 6.2.4'")
      podspec_content.gsub!("s.dependency 'GoogleSignIn', '~> 6.2.4'", "s.dependency 'GoogleSignIn', '~> 7.0'")
      File.write(plugin_podspec_path, podspec_content)
      puts "âœ… Patched CodetrixStudioCapacitorGoogleAuth.podspec to use GoogleSignIn ~> 7.0"
    end
  end
  
  # Set minimum deployment target for all targets
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      if config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'].to_f < 15.0
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      end
    end
  end
end
