require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '14.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorDevice', :path => '../../node_modules/@capacitor/device'
  pod 'CapacitorLocalNotifications', :path => '../../node_modules/@capacitor/local-notifications'
  pod 'CapacitorPreferences', :path => '../../node_modules/@capacitor/preferences'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CodetrixStudioCapacitorGoogleAuth', :path => '../../node_modules/@codetrix-studio/capacitor-google-auth'
end

target 'App' do
  capacitor_pods
  # Firebase for push notifications
  pod 'Firebase/Messaging'
  pod 'Firebase/Core'
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  # Add privacy manifests for Google SDKs that don't include them
  pods_dir = File.expand_path('Pods', __dir__)
  privacy_manifest_content = <<~XML
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
      <key>NSPrivacyTracking</key>
      <false/>
      <key>NSPrivacyTrackingDomains</key>
      <array/>
      <key>NSPrivacyCollectedDataTypes</key>
      <array>
        <dict>
          <key>NSPrivacyCollectedDataType</key>
          <string>NSPrivacyCollectedDataTypeUserID</string>
          <key>NSPrivacyCollectedDataTypeLinked</key>
          <true/>
          <key>NSPrivacyCollectedDataTypeTracking</key>
          <false/>
          <key>NSPrivacyCollectedDataTypePurposes</key>
          <array>
            <string>NSPrivacyCollectedDataTypePurposeAppFunctionality</string>
          </array>
        </dict>
      </array>
      <key>NSPrivacyAccessedAPITypes</key>
      <array>
        <dict>
          <key>NSPrivacyAccessedAPIType</key>
          <string>NSPrivacyAccessedAPICategoryUserDefaults</string>
          <key>NSPrivacyAccessedAPITypeReasons</key>
          <array>
            <string>CA92.1</string>
          </array>
        </dict>
        <dict>
          <key>NSPrivacyAccessedAPIType</key>
          <string>NSPrivacyAccessedAPICategoryFileTimestamp</string>
          <key>NSPrivacyAccessedAPITypeReasons</key>
          <array>
            <string>C617.1</string>
          </array>
        </dict>
      </array>
    </dict>
    </plist>
  XML
  
  ['GoogleSignIn', 'GTMAppAuth', 'GTMSessionFetcher'].each do |sdk_name|
    # Try different possible paths
    possible_paths = [
      File.join(pods_dir, sdk_name, 'Resources', 'PrivacyInfo.xcprivacy'),
      File.join(pods_dir, sdk_name, 'PrivacyInfo.xcprivacy'),
      File.join(pods_dir, sdk_name, sdk_name, 'Resources', 'PrivacyInfo.xcprivacy'),
    ]
    
    privacy_manifest_path = possible_paths.find { |path| File.exist?(File.dirname(path)) }
    
    if privacy_manifest_path && !File.exist?(privacy_manifest_path)
      FileUtils.mkdir_p(File.dirname(privacy_manifest_path))
      File.write(privacy_manifest_path, privacy_manifest_content)
      puts "✅ Added PrivacyInfo.xcprivacy for #{sdk_name} at #{privacy_manifest_path}"
    elsif !privacy_manifest_path
      # Create in the most likely location
      default_path = File.join(pods_dir, sdk_name, 'Resources', 'PrivacyInfo.xcprivacy')
      FileUtils.mkdir_p(File.dirname(default_path))
      File.write(default_path, privacy_manifest_content)
      puts "✅ Added PrivacyInfo.xcprivacy for #{sdk_name} at #{default_path}"
    end
  end
end
